<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracks Indexed</title>
  <link rel="stylesheet" type="text/css" href="./styles.css" />
</head>

<body>
  <input class="search-container" type="text" placeholder="Search..." oninput="searchForTrack(this.value)">

  <div id="current_playing_audio">
    <h2 id="DescOfTrack"></h2>
    <h3 id="playingArtist"></h3>
    <p>
      Start of Description:
      <button id="timeStampOfDecs"></button>
    </p>
    <a id="TrackTitle"></a>
    <div id="audioDiv">
      <audio autoplay controls></audio>
    </div>
    <details id="trackShabadIdDetails"></details>
  </div>

  <select id='pickKeertani' onchange="displayData()">
    <option value='All'>All</option>
  </select>


  <dialog id="myModal">
    <!-- <div id="myModal"> -->
    <form id="modal-content" onsubmit="formValidation(event)" method="post"
      action="http://45.76.2.28/trackIndex/addData.php">
      <span id="closeModal">&times;</span>
      <div class="userInputItem">
        <label for="userDesc">Description:</label>
        <input id="userDesc" name="description" placeholder="bin ek naam ik chit leen"></input>
      </div>
      <div class="userInputItem">
        <label for="userKeertani">Keertani:</label>
        <select id='userPickKeertani' onchange="modalSelectChanged()">
          <option value='Add New'>Add New</option>
        </select>
        <input id="userKeertani" name="keertani" style="display:none" placeholder="SDO Ji"></input>
      </div>
      <div class="userInputItem">
        <label for="userLink">Link:</label>
        <input type="url" id="userLink" name="link"
          placeholder="http://sikhsoul.com/golden_khajana_files/mp3/Keertan/Bhai%20Joginder%20Singh%20Talwara/Man%20kio%20bairaag%20kurehigaa.mp3"></input>
      </div>
      <div class="userInputItem">
        <p id="theShabadSelected"></p>
        <label for="usedShabadId">Shabad ID:</label>
        <input list="shabadId_list_opts" id="usedShabadId" name="shabadId" placeholder="687 or ਤਕਮਲ"
          oninput="add_shabad_from_user_input()"></input>
        <div id="shabadId_list_opts">
        </div>

        <a id="sttmLink" href="https://www.sikhitothemax.org/shabad?id=687&q=Ahrp&type=1&source=all&highlight=9290">
          <p>https://www.sikhitothemax.org/shabad?id=</p>
          <p id="highlightShabadId">687</p>
          <p>&q=Ahrp&type=1&source=all&highlight=9290</p>
        </a>
      </div>
      <div class="userInputItem">
        <label for="userTimestamp">Timestamp of where Description Happened:</label>
        <div id="userTimestamp">
          <input name="hours" id="hours" type="number" min="0" max="59" inputmode="numeric"></input>:
          <input name="mins" id="mins" type="number" min="0" max="59" inputmode="numeric"></input>:
          <input name="secs" id="secs" type="number" min="0" max="59" inputmode="numeric"></input>
        </div>
        <div id="userTimestamp">
          <label for="hours">hours:</label>
          <label for="mins">minutes:</label>
          <label for="secs">seconds</label>
        </div>
      </div>

      <button>Add</button>
    </form>
  </dialog>

  <div id="showModalDiv">
    <button id="showModalBtn">
      <span>&#43;</span>
    </button>
  </div>

  <h4 id="trackInfo">Vajhee</h4>
  <ol reversed id='trackNodes'></ol>
</body>

<!-- <script type="text/javascript" src="http://45.76.2.28/files/allShabads.js"></script> -->
<script type="text/javascript" src="./allShabads.js"></script>
<script>
  const ALL_TRACKS_DATA = [];
  modalStuff();


  function add_shabad_from_user_input() {
    const input_tag = document.getElementById("usedShabadId")
    const user_input = input_tag.value
    const list_opts = document.getElementById("shabadId_list_opts")
    list_opts.innerHTML = ''
    if (user_input === '') return

    let max_items_to_show = 10
    const keyObj = findShabadsKey(user_input)
    for (let key in keyObj) {
      const opt = document.createElement('p')
      opt.classList.add("shabad_opt_from_userinput")
      opt.onclick = () => {
        list_opts.innerHTML = ''
        input_tag.value = key
        document.getElementById("theShabadSelected").textContent = keyObj[key]
      }
      // opt.value = key
      opt.innerText = keyObj[key]
      list_opts.appendChild(opt)
      max_items_to_show -= 1
      if (max_items_to_show < 0) break
    }
  }

  function findShabadsKey(searchInput) {
    const all_matched_shabad_keys = {}
    for (const key in ALL_SHABADS) {
      const shabadArray = ALL_SHABADS[key]

      for (const line of shabadArray) {
        const wordsArray = line.split(' ')

        let line_matched = true
        for (let i = 0; i < searchInput.length; i++) {
          if (!line_matched) break
          if (wordsArray.length === i || wordsArray[i][0].toLowerCase() !== searchInput[i].toLowerCase()) {
            line_matched = false
          }
        }

        if (line_matched) {
          all_matched_shabad_keys[key] = line
          break
        }
      }
    }
    return all_matched_shabad_keys
  }

  function scrollToDivAccodingToUrl() {
    const url = window.location.href;
    const theId = url.split("#").splice(-1)[0]
    document.getElementById(theId).getElementsByTagName('button')[0].click()
    // if (theId !== url)
    //   document.getElementById(theId).scrollIntoView();
    // else
    //   console.log("Unable to scroll to ID")
  }

  function trackNodeBtnClicked(obj) {
    const current_playing_audio = document.getElementById('current_playing_audio')
    current_playing_audio.style.display = 'block'
    document.getElementById('DescOfTrack').innerText = obj.description
    document.getElementById('playingArtist').innerText = obj.keertani
    document.getElementById('timeStampOfDecs').innerText = obj.timeStamp
    document.getElementById('TrackTitle').innerText = getTrackTitle(obj.link)
    document.getElementById('TrackTitle').href = obj.link
    document.getElementsByTagName('audio')[0].src = obj.link

    document.getElementById('timeStampOfDecs').onclick = function () {
      const timeLst = obj.timeStamp.split(':')
      let totalSeconds = 0
      let muliplier = 1
      for (let i = timeLst.length - 1; i > -1; i--) {
        totalSeconds += muliplier * parseInt(timeLst[i])
        muliplier *= 60
      }
      document.getElementsByTagName('audio')[0].currentTime = totalSeconds
    }

    const details = document.getElementById('trackShabadIdDetails')
    if (obj.shabadId != '' && ALL_SHABADS[obj.shabadId]) {
      const summary = document.createElement('summary')
      summary.innerText = `Shabad ID: ${obj.shabadId}`
      details.innerText = ALL_SHABADS[obj.shabadId].join('\n')
      details.appendChild(summary)
      details.style.display = "block"
    } else {
      details.style.display = "none"
    }

    document.getElementById('current_playing_audio').scrollIntoView();
  }

  function displayData(objLst = ALL_TRACKS_DATA, alreadyFiltered = false) {
    /*
      <li>
        <div class="description">Description: Aaoo Hamare Raam Pyare Jio</div>
        <div class="artist">Keertani: Bhai Harpreet Singh</div>
        <div class="timestamp">Time Stamp: 37:18</div>
        <button>Track Title</button>
        <details>
          <summary>Shabad ID: 687</summary> ਆਉ ਹਮਾਰੈ ਰਾਮ ਪਿਆਰੇ ਜੀਉ ॥
          Come to me, O my Beloved Lord.
        </details>
        <button>Copy</button>
      </li>
    */
    const ol = document.getElementById('trackNodes')
    ol.innerHTML = '';

    let theData = objLst
    if (!alreadyFiltered)
      theData = filterDataByChosenOpt(objLst)

    document.getElementById('trackInfo').innerText = `Found ${theData.length} Tracks`

    for (let i = theData.length - 1; i > -1; i--) {
      const obj = theData[i];
      const mainDivCont = document.createElement('li')
      mainDivCont.setAttribute('class', 'trackNode')
      mainDivCont.setAttribute('id', obj.id)

      const divTopBar = document.createElement('div')
      divTopBar.setAttribute('class', 'topBarLine')

      const divNodeNum = document.createElement('div')
      divNodeNum.setAttribute('class', 'nodeNum')
      divNodeNum.innerText = `# ${obj.id}`
      divTopBar.appendChild(divNodeNum)

      const divDesc = document.createElement('div')
      divDesc.setAttribute('class', 'description')
      divDesc.innerText = `Description: ${obj.description}`
      divTopBar.appendChild(divDesc)

      mainDivCont.appendChild(divTopBar)

      const divArt = document.createElement('div')
      divArt.setAttribute('class', 'artist')
      divArt.innerText = `Keertani: ${obj.keertani}`
      mainDivCont.appendChild(divArt)

      const divTime = document.createElement('div')
      divTime.setAttribute('class', 'timestamp')
      divTime.innerText = `Time Stamp: ${obj.timeStamp}`
      mainDivCont.appendChild(divTime)

      const playTrackBtn = document.createElement('button')
      playTrackBtn.setAttribute('class', 'playTrackBtnWithTitle')
      playTrackBtn.innerText = getTrackTitle(obj.link)
      playTrackBtn.onclick = () => trackNodeBtnClicked(obj)
      mainDivCont.appendChild(playTrackBtn)

      if (obj.shabadId != '' && ALL_SHABADS[obj.shabadId]) {
        const details = document.createElement('details')
        const summary = document.createElement('summary')
        summary.innerText = `Shabad ID: ${obj.shabadId}`
        details.innerText = ALL_SHABADS[obj.shabadId].join('\n')
        details.appendChild(summary)
        mainDivCont.appendChild(details)
      }

      ol.appendChild(mainDivCont)
    }
  }

  function searchForTrack(e) {
    const wordsEntered = e.toLowerCase().split(' ')

    const theData = filterDataByChosenOpt()

    const results = theData.filter(obj => {
      const values = Object.values(obj);
      if (obj.shabadId != '' && ALL_SHABADS[obj.shabadId])
        values.push(ALL_SHABADS[obj.shabadId].join('\n'));

      for (const word of wordsEntered) {
        const wordInTrackObj = values.some(line => line.toLowerCase().includes(word));
        if (!wordInTrackObj) {
          return false;
        }
      }
      return true;
    });
    displayData(results, true)
  }

  function putOptsInSelect() {
    const allKeertanis = []
    ALL_TRACKS_DATA.forEach((track) => {
      if (!allKeertanis.includes(track.keertani)) {
        allKeertanis.push(track.keertani)
      }
    })

    const select = document.getElementById('pickKeertani')
    const selectModal = document.getElementById('userPickKeertani')
    for (const keertani of allKeertanis) {
      const opt = document.createElement('option')
      opt.setAttribute('value', keertani)
      opt.innerText = keertani
      select.appendChild(opt)

      const optForModal = opt.cloneNode(true)
      selectModal.prepend(optForModal)
    }
    modalSelectChanged() //so that the input field will get the value if modal not changed
  }

  function filterDataByChosenOpt() {
    const opt = document.getElementById('pickKeertani').value
    return theData = ALL_TRACKS_DATA.filter((item) => {
      if (opt == "All") {
        return true
      } else if (opt == item.keertani) {
        return true
      }
    })
  }


  function modalStuff() {
    const modal = document.getElementById("myModal");
    const showModalBtn = document.getElementById("showModalBtn");
    const closeModalButton = document.getElementById("closeModal");

    showModalBtn.addEventListener('click', () => {
      modal.showModal()
    })
    closeModalButton.addEventListener('click', () => {
      modal.close();

      //clear inputs
      document.getElementById("shabadId_list_opts").innerHTML = ''
      document.getElementById("theShabadSelected").textContent = ''

      const userInputItems = document.querySelectorAll('.userInputItem');
      userInputItems.forEach((item) => {
        const inputTags = item.getElementsByTagName('input')
        for (const tag of inputTags) {
          tag.value = '';
        }
      });
    });
    window.addEventListener('click', (event) => {
      // click outsite modal = close
      if (event.target === modal) {
        modal.close();
      }
    });
  }

  function modalSelectChanged() {
    const opt = document.getElementById('userPickKeertani').value
    const inputKeertani = document.getElementById('userKeertani')
    if (opt === "Add New") {
      inputKeertani.style.display = "block";
    } else {
      inputKeertani.style.display = "none";
      inputKeertani.value = opt
    }
  }

  function getTrackTitle(link) {return decodeURIComponent(link.replace(/%20/g, ' ').split('/').splice(-1))}

  fetch("http://45.76.2.28/trackIndex/getData.php").then((res) => {
    if (!res.ok) throw new Error("Something went wrong!");
    return res.json()
  }).then((data) => {
    for (let i = 0; i < data.length; i++) {
      const obj = data[i];
      obj.id = `${i + 1}`;
      ALL_TRACKS_DATA.push(obj)
    }
    displayData();
    putOptsInSelect();
    scrollToDivAccodingToUrl();
  }).catch((err) => {
    console.log(err)
  })

  function formValidation(e) {
    e.preventDefault()
    const form = document.querySelector("#modal-content")

    const desc = document.querySelector("#userDesc")
    const keertani = document.querySelector("#userKeertani")
    const link = document.querySelector("#userLink")

    if (link.value === "") {
      alert("Link is empty")
      return
    } 

    const additionalField = document.createElement("input");
    additionalField.name = "linkToGoTo";
    additionalField.value = window.location.href;
    form.appendChild(additionalField);
    form.submit()
  }
</script>

</html>
